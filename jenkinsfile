pipeline{
    agent any
    stages{

        stage("Clone repo"){
            steps{
                git branch: 'main', url: 'https://github.com/vishnu721/devops.git'
            }            
        }
        
        stage('Provision Ec2 instance'){
            steps {
                
                sh "terraform init"
                sh "terraform plan"
            }
        }

        stage('Approval'){
            steps{
                script{
                    def userInput = input(id: 'confirm', message: 'Apply Terraform?', parameters: [ [$class: 'BooleanParameterDefinition', defaultValue: false, description: 'Apply terraform', name: 'confirm'] ])    
                }
            }
        }

        stage("Apply Terraform"){
            steps{
                sh "terraform apply -input=false -auto-approve"
            }
        }

        stage("Read TF Output"){
            steps{
                script{
                    PRIVATE_IP = sh (
                    script: "terraform output -json private_ip | jq -r '.[0]'",
                    returnStdout: true
                    ).trim()

                    println("${PRIVATE_IP}")
                }
                
            }
        }

        stage("Run Ansible Playbook"){
            steps{
                sh "ansible-playbook -u ec2-user --private-key LinuxServer.pem -i '${PRIVATE_IP}' provision_web.yml"

            }
        }
      
    }
}
